services:
  emr-app:
    # テスト/E2E 用: ホストへポート公開しない（ポート競合を根絶する）
    build: .
    image: "${COMPOSE_PROJECT_NAME:-emr}_app_image"
    networks:
      emr_net:
        ipv4_address: "${EMR_APP_IP:-172.31.0.10}"
    volumes:
      - ./local_app:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  emr-app-public:
    # ブラウザアクセス用: ホストへポート公開する（必要なら EMR_PORT で変更）
    image: "${COMPOSE_PROJECT_NAME:-emr}_app_image"
    build: .
    ports:
      - "${EMR_PORT:-8083}:80"
    networks:
      - emr_net
    volumes:
      - ./local_app:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  emr-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - EMR_PORT=${EMR_PORT:-8083}
      - E2E_APP_IP=${EMR_APP_IP:-172.31.0.10}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - emr_net
    volumes:
      - ./local_app:/app/local_app
      - ./tools:/app/tools
      - ./docs:/app/docs
    depends_on:
      - emr-app

networks:
  emr_net:
    driver: bridge
    ipam:
      config:
        - subnet: "${EMR_SUBNET:-172.31.0.0/24}"
