# テスト仕様書

## 1. 単体テスト (emr.calc.test.js)

### 1.1 血圧分類テスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-BP-001 | 正常血圧の判定 | sys=110, dia=70 | "正常血圧" |
| UT-BP-002 | 正常高値血圧の判定 | sys=120, dia=70 | "正常高値血圧" |
| UT-BP-003 | 高値血圧の判定（収縮期） | sys=130, dia=70 | "高値血圧" |
| UT-BP-004 | 高値血圧の判定（拡張期） | sys=110, dia=80 | "高値血圧" |
| UT-BP-005 | I度高血圧の判定 | sys=135, dia=85 | "I度高血圧" |
| UT-BP-006 | II度高血圧の判定 | sys=145, dia=90 | "II度高血圧" |
| UT-BP-007 | III度高血圧の判定（収縮期） | sys=160, dia=80 | "III度高血圧" |
| UT-BP-008 | III度高血圧の判定（拡張期） | sys=130, dia=100 | "III度高血圧" |
| UT-BP-009 | 境界値（正常/正常高値） | sys=114, dia=74 | "正常血圧" |
| UT-BP-010 | 境界値（正常高値/高値） | sys=115, dia=74 | "正常高値血圧" |

### 1.2 BMI計算・分類テスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-BMI-001 | 低体重の判定 | weight=45, height=170 | "低体重（やせ）" |
| UT-BMI-002 | 普通体重の判定 | weight=65, height=170 | "普通体重" |
| UT-BMI-003 | 肥満1度の判定 | weight=80, height=170 | "肥満（1度）" |
| UT-BMI-004 | 肥満2度の判定 | weight=95, height=170 | "肥満（2度）" |
| UT-BMI-005 | null入力 | weight=null, height=170 | null |
| UT-BMI-006 | BMI計算精度 | weight=70, height=175 | BMI≒22.9（普通体重） |

### 1.3 SpO2分類テスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-SPO2-001 | 正常の判定 | spo2=98 | { label: "正常", level: "normal" } |
| UT-SPO2-002 | 軽度低下の判定 | spo2=93 | { label: "軽度低下", level: "caution" } |
| UT-SPO2-003 | 中等度低下の判定 | spo2=88 | { label: "中等度低下", level: "warning" } |
| UT-SPO2-004 | 重度低下の判定 | spo2=82 | { label: "重度低下", level: "danger" } |
| UT-SPO2-005 | null入力 | spo2=null | null |
| UT-SPO2-006 | 境界値（正常/軽度低下） | spo2=96 | { label: "正常", level: "normal" } |
| UT-SPO2-007 | 境界値（軽度/中等度） | spo2=91 | { label: "軽度低下", level: "caution" } |

### 1.4 年齢計算テスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-AGE-001 | 通常の年齢計算 | "1975-04-15"（今日が2026-02-17） | 50 |
| UT-AGE-002 | 誕生日当日 | 今日の生年月日（仮） | 当年齢 |
| UT-AGE-003 | 誕生日前日 | 明日が誕生日 | 前年齢 |

### 1.5 患者コード生成テスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-PC-001 | 患者なし（初回） | [] | "P0001" |
| UT-PC-002 | 既存患者あり | ["P0001", "P0002"] | "P0003" |
| UT-PC-003 | 飛び番あり | ["P0001", "P0003"] | "P0004"（最大値+1） |
| UT-PC-004 | 4桁ゼロ埋め | ["P0009"] | "P0010" |

### 1.6 バイタルサイン統計テスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-VS-001 | 血圧平均値計算 | [{sys:120,dia:80},{sys:130,dia:85}] | {avg: {sys:125, dia:82.5}} |
| UT-VS-002 | 空配列 | [] | 全フィールドnull |
| UT-VS-003 | null値含む | [{sys:120,dia:null},{sys:130,dia:85}] | diaの有効件数1件で計算 |
| UT-VS-004 | 最大・最小値 | [{sys:120},{sys:140},{sys:130}] | {max: 140, min: 120} |

### 1.7 バリデーションテスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-VAL-001 | 正常な血圧入力 | sys=120, dia=80 | valid: true |
| UT-VAL-002 | 収縮期が範囲外（低） | sys=40, dia=80 | valid: false |
| UT-VAL-003 | 収縮期が範囲外（高） | sys=310, dia=80 | valid: false |
| UT-VAL-004 | 収縮期 <= 拡張期 | sys=80, dia=80 | valid: false |
| UT-VAL-005 | 体温範囲外（低） | temp=33.9 | valid: false |
| UT-VAL-006 | 体温範囲外（高） | temp=42.1 | valid: false |
| UT-VAL-007 | 正常な体温入力 | temp=36.5 | valid: true |
| UT-VAL-008 | SpO2範囲外 | spo2=101 | valid: false |
| UT-VAL-009 | null入力（任意項目） | pulse=null | valid: true |
| UT-VAL-010 | 患者名が空 | name="" | valid: false |
| UT-VAL-011 | 生年月日が未来 | birthDate="2099-01-01" | valid: false |
| UT-VAL-012 | エクスポートデータ検証（正常） | {appName:"emr", patients:[], ...} | valid: true |
| UT-VAL-013 | エクスポートデータ検証（appName不一致） | {appName:"sbpr", ...} | valid: false |

### 1.8 検査値判定テスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-LAB-001 | 正常範囲内 | value="5800", min="3500", max="9700" | "normal" |
| UT-LAB-002 | 基準値下限未満 | value="3000", min="3500", max="9700" | "abnormal" |
| UT-LAB-003 | 基準値上限超過 | value="10000", min="3500", max="9700" | "abnormal" |
| UT-LAB-004 | 文字列検査値 | value="陽性", min=null, max=null | null |
| UT-LAB-005 | 基準値なし | value="5.0", min=null, max=null | null |

### 1.9 parseSuggestionsテスト
| テストID | テスト内容 | 入力 | 期待結果 |
|----------|-----------|------|----------|
| UT-SUG-001 | 提案あり | "本文\n{{SUGGEST:質問1}}\n{{SUGGEST:質問2}}" | { mainContent: "本文", suggestions: ["質問1", "質問2"] } |
| UT-SUG-002 | 提案なし | "本文のみ" | { mainContent: "本文のみ", suggestions: [] } |
| UT-SUG-003 | 提案3件 | "本文{{SUGGEST:Q1}}{{SUGGEST:Q2}}{{SUGGEST:Q3}}" | 3件の提案 |

## 2. E2Eテスト (e2e.test.js)

### 2.1 基本操作テスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-001 | ページ表示 | トップページにアクセス | タイトルが表示される |
| E2E-002 | 患者タブ表示 | トップページにアクセス | 患者タブがアクティブで患者一覧が表示される |
| E2E-003 | 患者登録 | 新規患者フォームに入力して保存 | 患者一覧に登録された患者が表示される |
| E2E-004 | 患者検索 | 氏名で検索 | 該当患者のみ絞り込まれる |
| E2E-005 | カルテ記録 | 患者選択後、SOAPフォームに入力して保存 | 診療記録が保存される |
| E2E-006 | バイタル記録 | バイタルフォームに入力して保存 | バイタルサインが保存される |
| E2E-007 | 処方登録 | 処方タブで処方情報を入力して保存 | 処方一覧に追加される |
| E2E-008 | 検査結果登録 | 検査タブで検査結果を入力して保存 | 検査一覧に追加される |
| E2E-009 | 履歴タブ表示 | 履歴タブに切替 | タイムライン形式で診療履歴が表示される |
| E2E-010 | pageerror検知 | 全操作中 | JSエラーが発生しないこと |

### 2.2 固定UI要素テスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-025 | バージョン情報表示 | トップページにアクセス | 右上にVer: / Build: が表示される |
| E2E-026 | スクロールトップボタン | トップページにアクセス | 左上にfixed配置のボタンが表示される |
| E2E-027 | スクロールトップボタン動作 | ページ下部で↑ボタンをクリック | ページが最上部にスクロールする |
| E2E-028 | ヘッダータップでページ先頭へ戻る | ページ下部でヘッダーをクリック | ページが最上部にスクロールする |

### 2.3 入力フォームUXテスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-021 | フォーカスで入力値が全選択される | バイタル数値フィールドにフォーカス | フィールドの値が全選択状態になる |
| E2E-022 | 患者切替でフォームリセット | 別の患者を選択 | 入力フォームがクリアされる |
| E2E-023 | アレルギー警告表示 | アレルギー登録済み患者を選択 | カルテタブ上部に警告バナーが表示される |
| E2E-024 | 前回SOAPのPlan参照 | 2回目以降のカルテ入力 | 前回のPlan内容が参考として表示される |

### 2.4 データ管理テスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-030 | エクスポート | 設定タブでエクスポートボタンクリック | JSONファイルがダウンロードされる |
| E2E-031 | インポート | JSONファイルを選択してインポート | データが復元される |
| E2E-032 | エクスポートJSON構造確認 | エクスポートしたJSONを確認 | appName="emr"、patients/records/prescriptions/labResults配列を含む |
| E2E-033 | インポート確認ダイアログ | インポートボタンクリック | 患者数・記録数が表示される確認ダイアログが出る |

### 2.5 AI診断機能テスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-040 | AI診断タブ非表示 | APIキー未設定でアクセス | AI診断タブが非表示 |
| E2E-041 | AI診断タブ表示 | APIキー設定後にアクセス | AI診断タブが表示される |
| E2E-042 | AI備考保存 | AI備考入力して保存 | localStorageに保存される |
| E2E-043 | 提案質問のパース | parseSuggestionsに候補付きテキストを渡す | mainContentとsuggestionsが正しく分離される |
| E2E-044 | 提案質問ボタン表示 | AI応答に{{SUGGEST:...}}を含むメッセージを表示 | .ai-suggestion-btnボタンが表示される |
| E2E-045 | AIモデル選択セレクト表示 | 設定タブのAI診断設定を確認 | ai-model-selectセレクトボックスが表示される |
| E2E-046 | AIモデル選択の初期値 | モデル未選択でアクセス | デフォルトでgpt-4o-miniが選択されている |
| E2E-047 | AIモデル選択の保存 | モデルを変更 | localStorageにemr_ai_modelキーで保存される |

### 2.6 グラフ表示テスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-050 | バイタルグラフ描画 | バイタルデータがある患者を選択してカルテタブ | Chart.jsキャンバスが描画される |
| E2E-051 | 検査グラフ描画 | 数値検査結果がある患者を選択して検査タブ | Chart.jsキャンバスが描画される |
| E2E-052 | グラフ期間切替 | 期間選択ボタンをクリック | グラフのデータ範囲が変わる |

### 2.7 PWA機能テスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-PWA-001 | manifest.jsonが読み込まれる | トップページにアクセス | link[rel=manifest]が存在し、href="/manifest.json"である |
| E2E-PWA-002 | Service Workerが登録される | トップページにアクセス後、SW登録を確認 | navigator.serviceWorker.controllerまたはregistration が存在する |
| E2E-PWA-003 | PWA meta tagsが設定されている | トップページにアクセス | theme-color, apple-mobile-web-app-capable等のmetaタグが存在する |
| E2E-PWA-004 | pageerrorが発生しない（PWA込み全タブ巡回） | 全タブを巡回 | JSエラーが発生しないこと |
| E2E-PWA-005 | 更新バナー要素が存在する | トップページにアクセス | #update-banner要素が存在し、初期状態ではdisplay:noneである |
| E2E-PWA-006 | 設定タブに「更新を確認」ボタンが表示される | 設定タブを開く | #check-update-btn ボタンが表示される |

### 2.8 レスポンシブデザインテスト
| テストID | テスト内容 | 操作 | 期待結果 |
|----------|-----------|------|----------|
| E2E-060 | モバイルビューポート | viewport 375x667に設定 | レイアウトが崩れず表示される |
| E2E-061 | タブレットビューポート | viewport 768x1024に設定 | レイアウトが崩れず表示される |
| E2E-062 | モバイルでの患者登録 | モバイルビューポートで患者登録操作 | フォームが正常に動作する |
