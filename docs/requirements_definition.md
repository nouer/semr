# 要件定義書

## 1. はじめに

### 1.1 目的
本ドキュメントは、ブラウザ完結型電子カルテアプリケーション（以下、emr: Electronic Medical Record）の構築に関する要件を定義するものである。本システムは、整骨院・鍼灸院・マッサージ院・個人クリニック等の小規模施術者が、自身の患者カルテをブラウザ上で完結して管理できることを目的とする。

### 1.2 背景
小規模な施術者・診療所では、紙カルテからの脱却が課題となっている。高価な既製電子カルテシステムや、複雑なサーバー管理が不要で、シンプルかつデータポータビリティを兼ね備えたWebアプリへの需要がある。本システムでは、ブラウザ上で完結するオフラインファースト設計により、サーバー不要・インストール不要で患者データを安全に管理できる。

## 2. システム概要

* **システム形態**: Webブラウザ上で動作するSingle Page Application (SPA)。
* **特徴**:
    * サーバーサイドでの処理を行わず、全てJavaScriptによるクライアントサイド処理で完結する。
    * データはブラウザのIndexedDBに保存し、サーバーへのデータ送信を一切行わない（AI機能使用時を除く）。
    * JSON形式でのエクスポート/インポートにより、データのバックアップ・移行が可能。
    * 患者ごとのSOAP形式診療記録・バイタルサインの推移グラフを提供する。
    * PWA対応によりオフラインでも動作し、ホーム画面へのインストールが可能。

## 3. 機能要件

### 3.1 患者管理機能
患者の基本情報を登録・管理する。
* **入力項目**:
    * 患者ID（自動採番、手動変更可）: 必須
    * 氏名（漢字）: 必須
    * 氏名（ふりがな）: 任意
    * 生年月日（YYYY-MM-DD）: 必須
    * 性別（男性/女性/その他）: 必須
    * 電話番号: 任意
    * メールアドレス: 任意
    * 住所: 任意
    * 保険証番号: 任意
    * 緊急連絡先（氏名・続柄・電話番号）: 任意
    * 初診日: 自動設定（手動変更可）
    * 担当施術者: 任意
    * 備考: 任意（フリーテキスト）
* **バリデーション**:
    * 氏名: 1文字以上100文字以内
    * 生年月日: 過去日付であること、0歳以上150歳以下
    * 電話番号: 半角数字・ハイフンのみ（任意）
    * メールアドレス: RFC準拠形式（任意）
* **機能**:
    * 患者一覧（氏名・ふりがな・生年月日・性別・最終受診日を表示）
    * 患者検索（氏名・ふりがな・患者IDでの絞り込み）
    * 患者の新規登録・編集・削除
* **保存先**: ブラウザのIndexedDB（`patients`ストア）

### 3.2 診療記録機能（SOAP形式）
患者ごとの診療記録をSOAP形式で入力・管理する。
* **入力項目**:
    * 受診日時（デフォルトは現在日時、手動変更可）: 必須
    * S（Subjective / 主訴）: 患者の自覚症状・訴え（フリーテキスト）
    * O（Objective / 所見）: 施術者による客観的所見（フリーテキスト）
    * A（Assessment / 評価）: 診断・評価（フリーテキスト）
    * P（Plan / 計画）: 治療計画・次回方針（フリーテキスト）
    * 施術内容メモ: 任意（フリーテキスト）
* **バリデーション**:
    * S, O, A, P のいずれか1つ以上の入力が必須
    * 各フィールド最大2000文字
* **機能**:
    * 記録の新規作成・編集・削除
    * 直近記録の表示（患者タブ・履歴タブ）
    * 前回記録のプリフィル（Planの内容を次回Sのヒントとして表示）
* **保存先**: ブラウザのIndexedDB（`records`ストア）

### 3.3 バイタルサイン記録機能
患者のバイタルサインを記録・管理する。
* **入力項目**（すべて任意、ただし1件以上の入力を推奨）:
    * 体温（℃）: 任意
    * 収縮期血圧（mmHg）: 任意
    * 拡張期血圧（mmHg）: 任意
    * 脈拍数（bpm）: 任意
    * SpO2（%）: 任意
    * 呼吸数（回/分）: 任意
    * 体重（kg）: 任意
    * 身長（cm）: 任意
    * 備考: 任意
* **バリデーション**:
    * 体温: 34.0〜42.0℃（小数点1桁まで）
    * 収縮期血圧: 50〜300 mmHg（整数）
    * 拡張期血圧: 30〜200 mmHg（整数）、収縮期 > 拡張期
    * 脈拍数: 20〜300 bpm（整数）
    * SpO2: 50〜100 %（整数）
    * 呼吸数: 1〜60 回/分（整数）
    * 体重: 1.0〜300.0 kg（小数点1桁まで）
    * 身長: 30〜250 cm（整数）
* **機能**:
    * バイタルサインは診療記録と同一画面で入力（紐付き）
    * 推移グラフ（Chart.js）による可視化
    * 期間選択（直近7日・30日・90日・全期間）
* **保存先**: ブラウザのIndexedDB（`records`ストアのvitalsフィールド）

### 3.4 処方箋管理機能
患者への処方情報を記録・管理する。
* **入力項目**:
    * 処方日（デフォルトは現在日付）: 必須
    * 薬剤名: 必須
    * 用量・単位: 任意
    * 用法（例: 毎食後、就寝前）: 任意
    * 処方日数: 任意（整数）
    * 備考: 任意
* **バリデーション**:
    * 薬剤名: 1文字以上200文字以内
    * 処方日数: 1〜365の整数（任意）
* **機能**:
    * 処方一覧の表示（診療記録に紐付けて表示）
    * 処方の新規登録・編集・削除
    * 同一患者の過去処方履歴の参照
* **保存先**: ブラウザのIndexedDB（`prescriptions`ストア）

### 3.5 検査結果管理機能
患者の検査結果を記録・管理する。
* **入力項目**:
    * 検査日: 必須
    * 検査種別（血液検査・尿検査・画像検査・その他）: 必須
    * 検査項目名: 必須
    * 検査値: 必須
    * 単位: 任意
    * 基準値（下限・上限）: 任意
    * 判定（正常/要注意/異常）: 任意
    * 備考: 任意
* **バリデーション**:
    * 検査項目名: 1文字以上200文字以内
    * 検査値: フリーテキスト（数値・文字両対応）
* **機能**:
    * 検査結果一覧（患者・検査種別・検査日でフィルタ）
    * 数値項目の推移グラフ表示（Chart.js）
    * 検査結果の新規登録・編集・削除
* **保存先**: ブラウザのIndexedDB（`lab_results`ストア）

### 3.6 アレルギー・既往歴管理機能
患者のアレルギー情報および既往歴を記録・管理する。
* **入力項目**（アレルギー）:
    * アレルゲン名: 必須
    * 反応の種類（薬物アレルギー・食物アレルギー・環境アレルギー・その他）: 必須
    * 症状: 任意
    * 重症度（軽度/中度/重度）: 任意
    * 確認日: 任意
    * 備考: 任意
* **入力項目**（既往歴）:
    * 疾患名: 必須
    * 診断日: 任意
    * 転帰（治癒/継続中/不明）: 任意
    * 担当医療機関: 任意
    * 備考: 任意
* **機能**:
    * 患者詳細画面にアレルギー・既往歴を常時表示
    * 診療記録入力時にアレルギー情報をウォーニング表示
    * 新規登録・編集・削除
* **保存先**: ブラウザのIndexedDB（`patients`ストアのallergies・medicalHistoryフィールド）

### 3.7 タイムライン表示機能
患者ごとの診療履歴を時系列で表示する。
* **表示内容**:
    * 診療日時
    * SOAPの主訴（S）の先頭50文字
    * バイタルサインのサマリー（体温・血圧・脈拍）
    * 処方の有無
    * 検査の有無
* **機能**:
    * 新しい順・古い順の切替
    * 月別グルーピング表示
    * 診療記録詳細への遷移

### 3.8 グラフ表示機能
バイタルサインおよび検査結果の推移をグラフで可視化する。
* **グラフ種類**: 折れ線グラフ（Chart.js v4）
* **表示データ**: 体温、収縮期血圧、拡張期血圧、脈拍、SpO2、体重（トグルで切替可）
* **期間選択**: 直近7日、30日、90日、全期間、カスタム範囲
* **正常値ライン**: 収縮期血圧135mmHg、拡張期血圧85mmHgの基準線を表示
* **レスポンシブ**: スマートフォンでも見やすいサイズに調整

### 3.9 データエクスポート機能
全データをJSON形式でファイルに出力する。
* **出力形式**: JSON
* **ファイル名**: `emr_export_YYYYMMDD_HHMMSS.json`
* **内容**: 全患者データ + 全診療記録 + 全処方 + 全検査結果 + メタ情報

### 3.10 データインポート機能
エクスポートしたJSONファイルを読み込み、データを復元する。
* **読み込み形式**: JSON（エクスポート形式と互換）
* **マージ戦略**: 既存データとのマージ（IDベースで重複排除）
* **バリデーション**: インポートデータの形式チェック
* **確認ダイアログ**: インポート前に患者数・記録数の確認を表示

### 3.11 AI診断支援機能
OpenAI APIを利用し、診療記録に基づいた臨床支援アドバイスを提供する。
* **API Key管理**: 設定タブでユーザーが自身のOpenAI API Keyを入力・保存（localStorage）できる。
* **タブ表示条件**: API Keyが設定されている場合のみ「AI診断」タブがナビゲーションに表示される。
* **プロンプト構築**: 以下の情報を自動的に含めたプロンプトを生成する。
    * 選択中の患者基本情報（年齢・性別・既往歴・アレルギー）
    * 直近の診療記録（SOAP形式、最大10件）
    * バイタルサインの推移（最大20件）
    * 最新の検査結果
    * 施術者が設定した備考（AI備考）
* **ストリーミング表示**: AIの生成テキストをリアルタイムで徐々に表示する（SSE）。
* **会話継続（壁打ち）**: 診断後に追加質問を入力して、会話を継続した追加相談ができる。
    * チャット形式のUI（ユーザー発言とAI応答が交互に表示）
    * 会話履歴は全てコンテキストとして保持される
* **提案質問（サジェスト）**: AIの回答の最後に、施術者が次に質問できる候補を3つ提示する。
    * AIレスポンス内に `{{SUGGEST:質問テキスト}}` フォーマットで質問候補を含める
    * 質問候補はクリック可能なボタンとして表示される
    * ボタンをクリックすると、その質問がフォローアップとして送信される
    * 新しいAI応答が来ると、前回の提案ボタンは非表示になる
* **注意表示**: AI診断は医療行為ではなく参考情報である旨の注意書きを常時表示する。

### 3.12 AI向け備考設定
設定タブにAI診断に含める備考情報の入力欄を設ける。
* **保存先**: localStorage
* **内容例**: 施術方針、専門分野、使用する施術手技など
* **用途**: AI診断のプロンプトに含めることで、より専門的・個別化されたアドバイスを得られる

### 3.13 固定UI要素
* **ページ先頭へ戻るボタン**: 画面左上に固定表示（`position: fixed`）。クリックでスムーズスクロールによりページ先頭へ移動する。印刷時は非表示。
* **バージョン情報表示**: 画面右上に固定表示（`position: fixed`）。アプリバージョンとビルド日時を2行で表示する。ビルド時に `version.js` が自動生成され、表示内容が更新される。印刷時は非表示。

### 3.14 PWA（Progressive Web App）対応
ネイティブアプリのようなユーザー体験を提供するため、PWA機能を実装する。
* **ホーム画面インストール**: Web App Manifest により、スマートフォン・タブレットのホーム画面にアプリアイコンを追加してフルスクリーンで起動できる。
* **完全オフライン対応**: Service Worker によりHTML/CSS/JS/ライブラリを全てキャッシュし、ネットワーク接続なしで動作する。
* **テーマカラー / スプラッシュスクリーン**: アプリ起動時にテーマカラー（#0f766e）のスプラッシュスクリーンを表示する。
* **バッジ表示**: Badge API を使用し、当日未診療の患者がいる場合にアプリアイコンにバッジを表示して記録忘れを防止する。

## 4. 非機能要件

### 4.1 動作環境
* **ブラウザ**: Google Chrome, Safari, Firefox, Edge等のモダンブラウザ最新版。
* **デバイス**: PC、タブレット、スマートフォン（レスポンシブデザイン対応）。
* **オフライン動作**: Service Worker により、ネットワーク未接続でも全機能（AI機能除く）が動作すること。

### 4.2 パフォーマンス
* データの保存・読み込みは瞬時（1秒未満）に完了すること。
* 患者数100名・診療記録1000件以上でもスムーズに動作すること。
* 初回ロード完了後、全機能がオフラインで動作すること。

### 4.3 セキュリティ・プライバシー
* 全データはブラウザ内（IndexedDB）にのみ保存し、AI機能使用時のOpenAI API呼び出しを除き、外部サーバーへのデータ送信を一切行わない。
* エクスポートファイルはユーザーのローカルストレージに保存される。
* AIに送信するデータに個人特定情報（氏名・電話番号等）を含めないよう、プロンプト構築時に除外する。
* AI機能の使用は任意であり、APIキー未設定時はAI機能が無効化される。

### 4.4 保守性
* Dockerコンテナによる環境構築手順が整備されていること。
* 計算ロジックとUI表示ロジックが分離されていること（`emr.calc.js` による純粋関数分離）。
* ドキュメント駆動開発により、仕様・テスト観点が明確であること。
